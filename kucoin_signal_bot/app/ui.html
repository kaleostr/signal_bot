<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<title>KuCoin Spot Signal Bot</title>
<style>
:root{--bg:#0f1115;--card:#171a22;--text:#e7eaf0;--muted:#9aa3b2;--line:#2a3040;--ok:#2ecc71;--warn:#f1c40f;--acc:#2d5bff}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:980px;margin:32px auto;padding:0 16px}
.h1{font-size:24px;font-weight:600;margin:0 0 6px}
.status{color:var(--muted);margin-bottom:16px}
.controls{display:flex;gap:8px;margin:16px 0 24px;align-items:center;flex-wrap:wrap}
.btn{display:inline-block;border-radius:10px;padding:10px 14px;background:#1b2030;border:1px solid var(--line);color:#fff;cursor:pointer}
.btn.primary{background:var(--acc);border-color:transparent}
.btn.ghost{background:transparent;border-color:var(--line);color:var(--muted)}
.seg{display:flex;border-radius:10px;overflow:hidden;border:1px solid var(--line)}
.seg button{padding:8px 12px;background:#141822;border:0;color:#c9d1e0;cursor:pointer}
.seg button.active{background:var(--acc);color:#fff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 4px 18px rgba(0,0,0,.25);margin-bottom:16px}
.card h2{font-size:16px;margin:0 0 12px}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,select{width:100%;background:#0c0f14;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:10px 12px;outline:none}
.small{font-size:12px;color:var(--muted)}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.notice{color:var(--muted);font-size:12px;margin-top:6px}
footer{color:var(--muted);font-size:12px;margin:8px 2px}
hr.sep{border:0;border-top:1px solid var(--line);margin:12px 0}

.tip{position:relative;cursor:help}
.tip::after{content:attr(data-tip);position:absolute;left:0;top:110%;min-width:220px;max-width:420px;
  background:#0b0e14;border:1px solid var(--line);padding:10px 12px;border-radius:10px;color:#d7deea;
  box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;pointer-events:none;transform:translateY(-2px);
  transition:opacity .12s ease, transform .12s ease;white-space:pre-line;z-index:10}
.tip:hover::after{opacity:1;transform:translateY(0)}
.tip::before{content:"";position:absolute;left:12px;top:100%;border:6px solid transparent;border-top-color:var(--line);opacity:0;transition:opacity .12s ease}
.tip:hover::before{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">KuCoin Spot Signal Bot</div>
  <div class="status" id="status">Status: —</div>

  <div class="controls">
    <button class="btn primary tip" data-tip="Сохранить настройки и применить их к сервису." onclick="save()">Save & Apply</button>
    <button class="btn tip" data-tip="Проверить доступность сервиса аддона (ping)." onclick="ping()">Ping</button>
    <button class="btn ghost tip" data-tip="Обновить значения на странице из текущих опций сервера." onclick="load()">Refresh</button>
    <div class="seg tip" data-tip="Быстрая установка минимума подтверждений (3/4/5).">
      <button id="m3" onclick="setMin(3)">3</button>
      <button id="m4" onclick="setMin(4)">4</button>
      <button id="m5" onclick="setMin(5)">5</button>
    </div>
  </div>

  <section class="card">
    <h2 class="tip" data-tip="Базовые параметры подключения и фильтрации рынка.">Basics</h2>
    <div class="grid2">
      <div>
        <label class="tip" data-tip="Токен Telegram-бота вида 123456:ABC... Получается у @BotFather.">Telegram token</label><input id="telegram_token" type="text" placeholder="123:ABC"/>
        <label class="tip" data-tip="ID чата/канала для уведомлений. Можно узнать через @userinfobot.">Telegram chat ID</label><input id="telegram_chat_id" type="text" placeholder="123456789"/>
      </div>
      <div>
        <label class="tip" data-tip="Котируемая валюта для пар. Обычно USDT.">Symbols quote</label><input id="symbols_quote" type="text" value="USDT"/>
        <label class="tip" data-tip="Сколько верхних по 24ч-объёму пар отбирать для сканирования.">Top N by 24h volume</label><input id="top_n_by_volume" type="number" value="120"/>
      </div>
    </div>
    <div class="grid2">
      <div>
        <label class="tip" data-tip="Минимальный дневной объём в долларах. Отсекает неликвид.">Min 24h volume (USD)</label><input id="min_vol_24h_usd" type="number" value="5000000"/>
        <label class="tip" data-tip="Пауза между сигналами по одной и той же паре, в минутах.">Cooldown (min)</label><input id="cooldown_minutes" type="number" value="20"/>
      </div>
      <div>
        <label class="tip" data-tip="Таймзона (IANA), влияет на сессию VWAP и расписание. Пример: Asia/Seoul.">Timezone (IANA)</label><input id="timezone" type="text" value="Asia/Seoul"/>
        <label class="tip" data-tip="Учитывать спред лучшего bid/ask при расчётах входа/тейков и фильтрации низкой чистой прибыли.">Use Level1 spread adjust</label><input id="use_level1_spread" type="checkbox"/>
      </div>
    </div>
  </section>

  <section class="card">
    <h2 class="tip" data-tip="Контроль требуемого числа подтверждений на 5m перед отправкой сигнала.">Signal Strength</h2>
    <label class="tip" data-tip="Сколько подтверждений нужно на 5m, чтобы отправить сигнал: EMA кросс/реκлейм, RSI≥порог, MACD импульс/кросс, VWAP↑ & price>VWAP.">Minimum confirmations (3/4/5)</label>
    <select id="min_confirms"><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
    <div class="notice">Bot will send only signals with confirmations ≥ N/5</div>
  </section>

  <div class="row">
    <section class="card">
      <h2 class="tip" data-tip="Тренд-фильтр: допускаем сигналы только когда 1-часовой контекст в нашу сторону.">Bias — 1h</h2>
      <label class="tip" data-tip="EMA на выбранном ТФ. Используется для тренда (Bias/Setup) и входа (Trigger).\n• fast — быстрая EMA\n• mid — средняя EMA\n• slow — медленная EMA">EMA (fast / mid / slow)</label>
      <div class="grid3">
        <input id="ema_fast_1h" type="number" value="20"/>
        <input id="ema_mid_1h"  type="number" value="50"/>
        <input id="ema_slow_1h" type="number" value="200"/>
      </div>
      <label class="tip" data-tip="RSI на этом ТФ. len — период RSI. min — минимально допустимое значение для фильтра (Bias/Setup).">RSI (len / min)</label>
      <div class="grid2">
        <input id="rsi_len_1h" type="number" value="14"/>
        <input id="rsi_min_1h" type="number" value="50"/>
      </div>
      <label class="tip" data-tip="MACD параметры: fast/slow — периоды EMA, signal — сигнальная линия. В Bias можно требовать рост гистограммы или MACD ≥ 0.">MACD (fast / slow / signal)</label>
      <div class="grid3">
        <input id="macd_fast_1h" type="number" value="12"/>
        <input id="macd_slow_1h" type="number" value="26"/>
        <input id="macd_signal_1h" type="number" value="9"/>
      </div>
      <hr class="sep"/>
      <label class="tip" data-tip="Включает требование правильного порядка EMA на 1h перед любыми входами."><input id="bias_need_ema_order" type="checkbox" checked/> Require EMA order</label>
      <label class="tip" data-tip="Какой порядок EMA на 1h считать «правильным»:\n• fast ≥ mid — мягче, больше сигналов\n• mid ≥ slow — жёстче, более трендово">EMA order mode</label>
      <select id="bias_ema_order_mode">
        <option value="fast_over_mid">fast ≥ mid</option>
        <option value="mid_over_slow">mid ≥ slow</option>
      </select>
      <label class="tip" data-tip="Доп. фильтр для Bias (1h):\n• Histogram rising — мягко\n• MACD ≥ 0 — жёстче\n• Off — не использовать MACD">MACD condition (optional)</label>
      <select id="bias_macd_condition">
        <option value="hist_rising">Histogram rising (soft, default)</option>
        <option value="macd_ge_0">MACD ≥ 0</option>
        <option value="off">Off</option>
      </select>
    </section>

    <section class="card">
      <h2 class="tip" data-tip="Контекст на 15m: порядок EMA, RSI и относительный объём (RVOL).">Setup — 15m</h2>
      <label class="tip" data-tip="EMA на выбранном ТФ. Используется для тренда (Bias/Setup) и входа (Trigger).\n• fast — быстрая EMA\n• mid — средняя EMA\n• slow — медленная EMA">EMA (fast / mid / slow)</label>
      <div class="grid3">
        <input id="ema_fast_15m" type="number" value="20"/>
        <input id="ema_mid_15m"  type="number" value="50"/>
        <input id="ema_slow_15m" type="number" value="200"/>
      </div>
      <label class="tip" data-tip="RSI на этом ТФ. len — период RSI. min — минимально допустимое значение для фильтра (Bias/Setup).">RSI (len / min)</label>
      <div class="grid2">
        <input id="rsi_len_15m" type="number" value="14"/>
        <input id="rsi_min_15m" type="number" value="50"/>
      </div>
      <label class="tip" data-tip="MACD параметры: fast/slow — периоды EMA, signal — сигнальная линия. В Bias можно требовать рост гистограммы или MACD ≥ 0.">MACD (fast / slow / signal)</label>
      <div class="grid3">
        <input id="macd_fast_15m" type="number" value="12"/>
        <input id="macd_slow_15m" type="number" value="26"/>
        <input id="macd_signal_15m" type="number" value="9"/>
      </div>
      <label class="tip" data-tip="Относительный объём: объём текущей свечи / SMA(20). Порог отсечёт низкообъёмные пробои.">RVOL 15m threshold</label><input id="rvol15m_min" type="number" step="0.1" value="1.6"/>
    </section>
  </div>

  <div class="row">
    <section class="card">
      <h2 class="tip" data-tip="Точка входа на 5m: быстрые EMA, RSI-over, MACD импульс/кросс, VWAP.">Trigger — 5m</h2>
      <label class="tip" data-tip="EMA на выбранном ТФ. Используется для тренда (Bias/Setup) и входа (Trigger).\n• fast — быстрая EMA\n• mid — средняя EMA\n• slow — медленная EMA">EMA (fast / mid / slow)</label>
      <div class="grid3">
        <input id="ema_fast_5m" type="number" value="9"/>
        <input id="ema_mid_5m"  type="number" value="21"/>
        <input id="ema_slow_5m" type="number" value="50"/>
      </div>
      <label class="tip" data-tip="RSI на 5m: len — период, over — порог входа (например 55).">RSI (len / over)</label>
      <div class="grid2">
        <input id="rsi_len_5m" type="number" value="9"/>
        <input id="rsi_over_5m" type="number" value="55"/>
      </div>
      <label class="tip" data-tip="MACD параметры: fast/slow — периоды EMA, signal — сигнальная линия. В Bias можно требовать рост гистограммы или MACD ≥ 0.">MACD (fast / slow / signal)</label>
      <div class="grid3">
        <input id="macd_fast_5m" type="number" value="8"/>
        <input id="macd_slow_5m" type="number" value="21"/>
        <input id="macd_signal_5m" type="number" value="5"/>
      </div>
    </section>

    <section class="card">
      <h2 class="tip" data-tip="Защита от шума: ограничение тела пробоя и дистанция до EMA200(5m).">Anti-Noise</h2>
      <label class="tip" data-tip="Лимит размера тела пробойной свечи относительно ATR(14). Защита от аномально больших свечей.">Max breakout candle body (×ATR)</label><input id="breakout_body_max_atr_mult" type="number" step="0.1" value="1.8"/>
      <label class="tip" data-tip="Минимальная дистанция цены до EMA200 на 5m (в процентах). Избегаем входа прямо у EMA200.">Min distance to EMA200 (5m, %)</label><input id="ema200_5m_min_distance_pct" type="number" step="0.1" value="0.2"/>
    </section>
  </div>

  <div class="row">
    <section class="card">
      <h2 class="tip" data-tip="Настройки тейков, комиссий и минимальной чистой доходности.">Exits & Costs (Advanced)</h2>
      <label class="tip" data-tip="Уровни тейков в десятичной форме: 0.007 = 0.7%. Оставьте пусто для значений по умолчанию.">TP levels (decimals, comma separated)</label><input id="tp_levels_pct" type="text" value="0.7,1.2,2.0"/>
      <div class="grid3">
        <div>
          <label class="tip" data-tip="Комиссия тейкера в базисных пунктах: 10 bps = 0.1%.">Taker fee (bps)</label><input id="taker_fee_bps" type="number" value="10"/>
        </div>
        <div>
          <label class="tip" data-tip="Доп. буфер на проскальзывание/спред, в bps.">Extra buffer (bps)</label><input id="roundtrip_extra_buffer_bps" type="number" value="5"/>
        </div>
        <div>
          <label class="tip" data-tip="Минимальная ожидаемая чистая прибыль после комиссий; слабые сигналы отфильтровываются.">Min net profit (bps)</label><input id="min_net_profit_bps" type="number" value="0"/>
        </div>
      </div>
    </section>
  </div>

  <footer id="footer">Changes are applied within a minute.</footer>
</div>

<script>
async function load(){
  const r = await fetch('/api/options'); const data = await r.json();
  const keys = Object.keys(data||{});
  for (const k of keys){ const el = document.getElementById(k); if(!el) continue;
    if (el.type === 'checkbox') el.checked = !!data[k];
    else el.value = data[k];
  }
  // status
  const s = await fetch('/health').then(r=>r.json()).catch(()=>({}));
  const status = document.getElementById('status');
  status.textContent = `Status: ${s.ok?'Running':'—'} • Tracked: ${s.tracked_symbols??'—'} • Signals: ${s.signals_sent??'—'} • min: ${s.min_confirms??'—'}`;
  // highlight segment
  ['m3','m4','m5'].forEach(id=>document.getElementById(id).classList.remove('active'));
  const m = data.min_confirms||3; const btn = document.getElementById('m'+m); if(btn) btn.classList.add('active');
}
async function save(){
  const fields=[
    "telegram_token","telegram_chat_id","min_vol_24h_usd","cooldown_minutes","timezone",
    "symbols_quote","top_n_by_volume","min_confirms",
    // legacy global indicators (kept for backward compatibility)
    "ema_fast","ema_mid","ema_slow","rsi_length","macd_fast","macd_slow","macd_signal",
    // per‑TF
    "ema_fast_1h","ema_mid_1h","ema_slow_1h","rsi_len_1h","rsi_min_1h","macd_fast_1h","macd_slow_1h","macd_signal_1h",
    "ema_fast_15m","ema_mid_15m","ema_slow_15m","rsi_len_15m","rsi_min_15m","macd_fast_15m","macd_slow_15m","macd_signal_15m","rvol15m_min",
    "ema_fast_5m","ema_mid_5m","ema_slow_5m","rsi_len_5m","rsi_over_5m","macd_fast_5m","macd_slow_5m","macd_signal_5m",
    // bias options
    "bias_need_ema_order","bias_ema_order_mode","bias_macd_condition",
    // anti-noise & exits
    "breakout_body_max_atr_mult","ema200_5m_min_distance_pct",
    "taker_fee_bps","roundtrip_extra_buffer_bps","min_net_profit_bps","tp_levels_pct","use_level1_spread"
  ];
  const body={};
  for(const k of fields){const el=document.getElementById(k); if(!el) continue;
    body[k] = (el.type==='checkbox')? el.checked : el.value;
  }
  // normalize numbers and arrays
  const ints=["min_vol_24h_usd","cooldown_minutes","top_n_by_volume","min_confirms",
              "ema_fast","ema_mid","ema_slow","rsi_length","macd_fast","macd_slow","macd_signal",
              "ema_fast_1h","ema_mid_1h","ema_slow_1h","rsi_len_1h","rsi_min_1h","macd_fast_1h","macd_slow_1h","macd_signal_1h",
              "ema_fast_15m","ema_mid_15m","ema_slow_15m","rsi_len_15m","rsi_min_15m","macd_fast_15m","macd_slow_15m","macd_signal_15m",
              "ema_fast_5m","ema_mid_5m","ema_slow_5m","rsi_len_5m","rsi_over_5m",
              "taker_fee_bps","roundtrip_extra_buffer_bps","min_net_profit_bps"];
  const floats=["rvol15m_min","breakout_body_max_atr_mult","ema200_5m_min_distance_pct"];
  ints.forEach(k=>{ if(body[k]!==undefined && body[k]!=="" ) body[k]=parseInt(body[k],10); });
  floats.forEach(k=>{ if(body[k]!==undefined && body[k]!=="" ) body[k]=parseFloat(body[k]); });
  if(typeof body.tp_levels_pct==='string'){
    body.tp_levels_pct = body.tp_levels_pct.split(',').map(s=>parseFloat(s.trim())).filter(x=>!isNaN(x));
  }
  await fetch('/api/options',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  document.getElementById('footer').textContent='Saved. Changes will apply within ~60s.';
}
async function ping(){ await fetch('/api/ping'); }
async function setMin(n){
  fetch('/api/set_min?val='+n).then(()=>{
    ['m3','m4','m5'].forEach(id=>document.getElementById(id).classList.remove('active'));
    const btn = document.getElementById('m'+n); if(btn) btn.classList.add('active');
    const mc = document.getElementById('min_confirms'); if(mc) mc.value = String(n);
  });
}
load();
</script>
</body></html>
